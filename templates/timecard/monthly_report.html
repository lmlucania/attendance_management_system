{% extends "base.html" %}

{% block title %}
    打刻一覧
{% endblock %}
{% block content %}
    <div>
        <button class="btn btn-sm btn-success" id="prev">先月</button>
        {{ BOM }} ~ {{ EOM }}
        <button class="btn btn-sm btn-success" id="next">次月</button>
        {% if state == '0' %}
        <a class="btn btn-sm btn-primary" href="{% url 'timecard:timecard_upload' %}">アップロード</a>
        <button class="btn btn-sm btn-primary" id="promote">
            勤怠を締める
        </button>
        {% elif state == '1' %}
        <button class="btn btn-sm btn-primary" disabled>
            申請中
        </button>
        {% elif state == '2' %}
        <button class="btn btn-sm btn-primary" disabled>
            承認済み
        </button>
        {% endif %}
    </div>
    <div>
        <div>表示月
        {{ search_form.month }}
        </div>
        <div class="col-sm-12 text-right">
            <button class="btn btn-sm btn-primary" id="export">Excel出力</button>
        </div>
    </div>
    <table class="table table-striped">
    <tr>
        <th>日付</th>
        <th>出勤時刻</th>
        <th>退勤時刻</th>
        <th>拘束時間</th>
        <th>休憩時間</th>
        <th>労働時間</th>
        <th style="width: 70px;"></th>
    </tr>
    {% for day_report in monthly_report %}
    <tr>
        <td>{{ day_report.day }}</td>
        <td>{{ day_report.start_work|date:"H:i" }}</td>
        <td>{{ day_report.end_work|date:"H:i" }}</td>
        <td>{{ day_report.enter_break|date:"H:i" }}</td>
        <td>{{ day_report.end_break|date:"H:i" }}</td>
        <td>{{ day_report.paid_work_hour }}</td>
        <td>
            {% if state == '0' %}
                <button class="btn btn-sm btn-success" value={{ day_report.day }} id="edit">編集</button>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
{% endblock %}
{% block script %}
    <script>
    window.addEventListener('pageshow', () => {
    if(performance.getEntriesByType("navigation")[0].type === 'back_forward'){
        location.reload();
    }
    });
    let displayMonth = $('#id_month').val().replace('-', '');
    let BOM = '{{ BOM }}'.replace('日', '').replace(/[^0-9]/g, '/');
    let nextMonth = new Date(BOM);
    let prevMonth = new Date(BOM);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    prevMonth.setMonth(prevMonth.getMonth() - 1);
    $(function() {
        $('#upload').on('click', function() {
            $('#upload-form').prop('action', $(this).data('url')).submit();
        });
        $('#id_month').change(function(){
            location.href = "{% url 'timecard:timecard_monthly_report' %}?month=" + $('#id_month').val().replace('-', '');
        })
        $('#export').on('click', function(){
            location.href = "{% url 'timecard:timecard_export' %}?month=" + displayMonth + "&mode=export";
        })
        $('#next').on('click', function(){
            location.href = "{% url 'timecard:timecard_monthly_report' %}?month=" + convertParam(nextMonth);
        })
        $('#prev').on('click', function(){
            location.href = "{% url 'timecard:timecard_monthly_report' %}?month=" + convertParam(prevMonth);
        })
        $('#promote').on('click', function(){
            location.href = "{% url 'timecard:timecard_monthly_report' %}?month=" + displayMonth + "&mode=promote";
        })
        $(document).on('click', '#edit', function(){
            let day = $(this).val().padStart(2, '0');
            location.href = "{% url 'timecard:timecard_edit' %}?date=" + convertParam(new Date(BOM)) + day;
        })
    })
    function convertParam(date){
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        return date.getFullYear() + month;
    }
    </script>
{% endblock %}